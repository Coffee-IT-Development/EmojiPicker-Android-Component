---
format_version: '8'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android
trigger_map:
  - push_branch: main
    workflow: release
workflows:
  release:
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.1: {}
      - script@1:
          inputs:
            - content: |-
                echo "BITRISE_GIT_BRANCH=$BITRISE_GIT_BRANCH"
                export CURRENT_BRANCH="${BITRISE_GIT_BRANCH}"
                echo "CURRENT_BRANCH=CURRENT_BRANCH"
      - cache-pull@2: {}
      - file-downloader@1:
          inputs:
            - source: "$BITRISEIO_PUBRING_URL"
            - destination: "/$BITRISE_GIT_BRANCH/pubring.kbx"
      - script@1:
          inputs:
            - content: |-
                echo "SONATYPE_NEXUS_USERNAME=$SONATYPE_NEXUS_USERNAME" >> gradle.properties
                echo "SONATYPE_NEXUS_PASSWORD=$SONATYPE_NEXUS_PASSWORD" >> gradle.properties
                echo "signing.keyId=$GPG_KEY_ID" >> gradle.properties
                echo "signing.password=$GPG_PASSPHRASE" >> gradle.properties
                echo "signing.secretKeyRingFile=/$BITRISE_GIT_BRANCH/pubring.kbx" >> gradle.properties
                ./gradlew $BITRISE_GIT_BRANCH:uploadArchives --no-daemon --no-parallel
                ./gradlew $BITRISE_GIT_BRANCH:closeAndReleaseRepository
      - cache-push@2: {}
      - slack@3:
          inputs:
            - channel: ''
            - text: 'Android $APP_NAME $BITRISE_GIT_BRANCH build deployed to Maven :rocket:'
            - emoji: ''
            - thumb_url: "$ICON_URL"
            - icon_url: ''
            - from_username: ''
            - footer: ''
            - pretext: "*Deployment succeeded!*"
            - buttons: |
                View on Maven|${MAVEN_URL}
                View Build|${BITRISE_BUILD_URL}
            - webhook_url: "$SLACK_WEBHOOK_URL"
          is_always_run: false
          title: Send a Slack message (success)
      - slack@3:
          inputs:
            - channel: ''
            - text: 'Android $APP_NAME $BITRISE_GIT_BRANCH deployment failed :rocket-explosion:'
            - emoji: ''
            - thumb_url: "$ICON_URL"
            - icon_url: ''
            - from_username: ''
            - footer: ''
            - pretext: "*Deployment failed!*"
            - color: "#c33b46"
            - webhook_url: "$SLACK_WEBHOOK_URL"
          is_always_run: true
          run_if: ".IsBuildFailed"
          title: Send a Slack message (error)
app:
  envs:
    - opts:
        is_expand: false
      PROJECT_LOCATION: "."
    - opts:
        is_expand: false
      MODULE: app
    - opts:
        is_expand: false
      VARIANT: ''
meta:
  bitrise.io:
    stack: linux-docker-android-20.04